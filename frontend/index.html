<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PhotoAI Analyzer - Analyse Professionnelle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto';
            margin: 0;
            padding: 0;
        }
        .spinner {
            border: 4px solid rgba(71, 85, 105, 0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .metric-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .style-item {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState } = React;
        const API_URL = 'https://photo-analyzer-1-x9qb.onrender.com'.replace(/\/$/, '');
        

        function MetricCard({ label, value, max, color }) {
            const percentage = Math.min((value / max) * 100, 100);
            return (
                <div className="metric-card bg-slate-900/50 rounded-xl p-4 border border-slate-700">
                    <p className="text-xs text-slate-400 mb-2 font-semibold">{label}</p>
                    <p className="text-2xl font-bold text-white mb-3">{value.toFixed(1)}</p>
                    <div className="w-full bg-slate-700 rounded-full h-2 overflow-hidden">
                        <div
                            className={`bg-gradient-to-r ${color} h-full transition-all`}
                            style={{ width: `${percentage}%` }}
                        ></div>
                    </div>
                </div>
            );
        }

        function StyleRankingItem({ rank, style, score }) {
            const colors = {
                1: 'from-yellow-500 to-orange-500',
                2: 'from-gray-400 to-gray-500',
                3: 'from-orange-600 to-orange-700'
            };
            const badges = ['ü•á', 'ü•à', 'ü•â'];
            
            return (
                <div className="style-item bg-slate-900/50 border border-slate-700 rounded-xl p-4 hover:border-blue-500/50 transition-all">
                    <div className="flex items-center justify-between mb-2">
                        <span className="text-2xl">{badges[rank - 1] || 'üìç'}</span>
                        <span className="text-sm font-semibold text-slate-300">#{rank}</span>
                    </div>
                    <p className="text-lg font-bold text-white mb-2">{style}</p>
                    <div className="flex items-center gap-3">
                        <div className="flex-1 bg-slate-700 rounded-full h-2 overflow-hidden">
                            <div
                                className={`bg-gradient-to-r ${colors[rank] || 'from-blue-500 to-cyan-500'} h-full transition-all`}
                                style={{ width: `${score}%` }}
                            ></div>
                        </div>
                        <span className="text-sm font-bold text-white">{score}%</span>
                    </div>
                </div>
            );
        }

        function PhotoAnalyzer() {
            const [uploadedImage, setUploadedImage] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [analysisResult, setAnalysisResult] = useState(null);
            const [dragActive, setDragActive] = useState(false);

            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                const files = e.dataTransfer.files;
                if (files && files[0]) {
                    handleImageUpload(files[0]);
                }
            };

                const handleImageUpload = (file) => {
    // AJOUT DE CETTE V√âRIFICATION :
    if (!file) {
        console.warn("Aucun fichier s√©lectionn√©");
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        setUploadedImage(e.target.result);
        setAnalysisResult(null);
        analyzeImage(e.target.result);
    };
    
    // Si 'file' est undefined, cette ligne fait planter l'application
    reader.readAsDataURL(file); 
};
           const analyzeImage = async (imageData) => {
    setIsAnalyzing(true);
    try {
        const response = await fetch(`${API_URL}/api/analyze`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: imageData })
        });

        // DEBUG : afficher la r√©ponse brute
        const text = await response.text();
        console.log("R√©ponse brute:", text);

        if (!text.trim().startsWith('{')) {
            throw new Error("La r√©ponse n'est pas du JSON");
        }

        
        // Essayer de parser en JSON
        const data = JSON.parse(text);
        console.log("Donn√©es re√ßues:", data);
        setAnalysisResult(data);
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'analyse: ' + error.message);
    } finally {
        setIsAnalyzing(false);
    }
};

            // Extraire top 5 styles
            const getTopStyles = () => {
                if (!analysisResult?.style_affinities?.top_5) return [];
                return analysisResult.style_affinities.top_5.map(s => ({
                    label: s.label,
                    score: Math.round(s.score * 100)
                }));
            };

            // Extraire sujets d√©tect√©s
            const getDetectedObjects = () => {
                if (!analysisResult?.subjects) return [];
                return analysisResult.subjects.slice(0, 10);
            };

            // Extraire recommandations composition
            const getCompositionRecommendations = () => {
                if (!analysisResult?.composition_rules?.prioritized_suggestions) return [];
                return analysisResult.composition_rules.prioritized_suggestions.slice(0, 5);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
                    {/* Header */}
                    <header className="border-b border-slate-700 bg-slate-900/50 backdrop-blur sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-6 py-8">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center text-2xl">
                                    ‚ú®
                                </div>
                                <div>
                                    <h1 className="text-4xl font-bold text-white">PhotoAI Analyzer</h1>
                                    <p className="text-slate-400 text-sm">Analyse compl√®te ‚Ä¢ Styles ‚Ä¢ Composition ‚Ä¢ IA</p>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main */}
                    <main className="max-w-7xl mx-auto px-6 py-12">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            {/* Upload Zone */}
                            <div className="lg:col-span-1">
                                <div
                                    onDragEnter={handleDrag}
                                    onDragLeave={handleDrag}
                                    onDragOver={handleDrag}
                                    onDrop={handleDrop}
                                    className={`border-2 border-dashed rounded-2xl p-8 text-center cursor-pointer transition-all mb-6 ${
                                        dragActive
                                            ? 'border-blue-500 bg-blue-500/10'
                                            : 'border-slate-600 bg-slate-800/50 hover:bg-slate-800'
                                    }`}
                                >
                                    <input
                                        type="file"
                                        accept="image/*"
                                        onChange={(e) => e.target.files && handleImageUpload(e.target.files[0])}
                                        className="hidden"
                                        id="image-input"
                                    />
                                    
                                    <label htmlFor="image-input" className="flex flex-col items-center gap-4 cursor-pointer">
                                        <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center text-4xl">
                                            üì∏
                                        </div>
                                        <div>
                                            <p className="font-semibold text-white text-lg">D√©pose ta photo</p>
                                            <p className="text-sm text-slate-400">ou clique</p>
                                            <p className="text-xs text-slate-500 mt-2">JPG, PNG ‚Ä¢ Max 10MB</p>
                                        </div>
                                    </label>
                                </div>

                                {uploadedImage && (
                                    <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                                        <p className="text-sm font-semibold text-slate-300 mb-3">üì∑ Aper√ßu</p>
                                        <img
                                            src={uploadedImage}
                                            alt="Preview"
                                            className="w-full rounded-xl border border-slate-700 object-cover max-h-96"
                                        />
                                    </div>
                                )}
                            </div>

                            {/* Results */}
                            <div className="lg:col-span-2">
                                {isAnalyzing ? (
                                    <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-16 flex items-center justify-center">
                                        <div className="text-center">
                                            <div className="flex justify-center mb-4">
                                                <div className="spinner"></div>
                                            </div>
                                            <p className="text-lg font-semibold text-white">Analyse en cours...</p>
                                            <p className="text-slate-400 text-sm mt-2">Cela peut prendre 10-15 secondes</p>
                                        </div>
                                    </div>
                                ) : analysisResult ? (
                                    <div className="space-y-6">
                                        {/* Metrics */}
                                        <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                                            <h2 className="text-2xl font-bold text-white mb-6">üìä Analyse Technique</h2>
                                            <div className="grid grid-cols-2 gap-4">
                                                <MetricCard
                                                    label="Nettet√©"
                                                    value={analysisResult.sharpness || 0}
                                                    max={300}
                                                    color="from-blue-500 to-cyan-500"
                                                />
                                                <MetricCard
                                                    label="Luminosit√©"
                                                    value={analysisResult.brightness || 0}
                                                    max={255}
                                                    color="from-yellow-500 to-orange-500"
                                                />
                                                <MetricCard
                                                    label="Contraste"
                                                    value={analysisResult.contrast || 0}
                                                    max={100}
                                                    color="from-purple-500 to-pink-500"
                                                />
                                                <MetricCard
                                                    label="Bruit"
                                                    value={Math.max(0, 50 - (analysisResult.noise || 0))}
                                                    max={50}
                                                    color="from-green-500 to-emerald-500"
                                                />
                                            </div>
                                        </div>

                                        {/* Quality Score */}
                                        <div className="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 border border-blue-500/30 rounded-2xl p-8">
                                            <h2 className="text-2xl font-bold text-white mb-4">‚ö° Score de Qualit√©</h2>
                                            <div className="flex items-center gap-8">
                                                <div>
                                                    <div className="text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400">
                                                        {analysisResult.quality_score || 0}
                                                    </div>
                                                    <p className="text-slate-300">/ 100</p>
                                                </div>
                                                <div className="flex-1">
                                                    <div className="w-full bg-slate-700 rounded-full h-3 overflow-hidden">
                                                        <div
                                                            className="bg-gradient-to-r from-blue-500 to-cyan-500 h-full"
                                                            style={{ width: `${(analysisResult.quality_score || 0)}%` }}
                                                        ></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Top 5 Styles */}
                                        {getTopStyles().length > 0 && (
                                            <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                                                <h2 className="text-2xl font-bold text-white mb-6">üé® Top 5 Styles Compatibles</h2>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {getTopStyles().map((style, idx) => (
                                                        <StyleRankingItem
                                                            key={idx}
                                                            rank={idx + 1}
                                                            style={style.label}
                                                            score={style.score}
                                                        />
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* Detected Objects */}
                                        {getDetectedObjects().length > 0 && (
                                            <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                                                <h2 className="text-2xl font-bold text-white mb-6">üéØ Objets D√©tect√©s</h2>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr className="border-b border-slate-700">
                                                                <th className="text-left py-3 px-4 text-slate-300 font-semibold">Objet</th>
                                                                <th className="text-left py-3 px-4 text-slate-300 font-semibold">Confiance</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {getDetectedObjects().map((obj, idx) => (
                                                                <tr key={idx} className="border-b border-slate-700/50 hover:bg-slate-900/50 transition-all">
                                                                    <td className="py-3 px-4 text-slate-200 capitalize">{obj.class}</td>
                                                                    <td className="py-3 px-4">
                                                                        <div className="flex items-center gap-2">
                                                                            <div className="w-16 bg-slate-700 rounded-full h-2 overflow-hidden">
                                                                                <div
                                                                                    className="bg-gradient-to-r from-green-500 to-emerald-500 h-full"
                                                                                    style={{ width: `${(obj.confidence || 0) * 100}%` }}
                                                                                ></div>
                                                                            </div>
                                                                            <span className="text-slate-300 font-semibold">{Math.round((obj.confidence || 0) * 100)}%</span>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}

                                        {/* Composition Recommendations */}
                                        {getCompositionRecommendations().length > 0 && (
                                            <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                                                <h2 className="text-2xl font-bold text-white mb-6">üìê Recommandations Composition</h2>
                                                <ul className="space-y-3">
                                                    {getCompositionRecommendations().map((rec, idx) => (
                                                        <li key={idx} className="flex gap-3 p-3 bg-slate-900/50 rounded-lg border border-slate-700 hover:border-blue-500/50 transition-all">
                                                            <span className="text-blue-400 font-bold text-xl">‚Üí</span>
                                                            <span className="text-slate-200">{rec}</span>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        {/* Advice */}
                                        {analysisResult.advice && analysisResult.advice.length > 0 && (
                                            <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                                                <h2 className="text-2xl font-bold text-white mb-6">üí° Conseils d'Experts</h2>
                                                <ul className="space-y-3">
                                                    {analysisResult.advice.slice(0, 6).map((tip, idx) => (
                                                        <li key={idx} className="flex gap-3 text-slate-200 text-sm p-3 bg-slate-900/50 rounded-lg border border-slate-700 hover:border-yellow-500/50 transition-all">
                                                            <span className="text-yellow-400 font-bold">üí°</span>
                                                            <span>{tip}</span>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        {/* New Analysis */}
                                        <button
                                            onClick={() => {
                                                setUploadedImage(null);
                                                setAnalysisResult(null);
                                            }}
                                            className="w-full bg-gradient-to-r from-slate-700 to-slate-600 text-white font-semibold py-3 px-6 rounded-xl hover:from-slate-600 hover:to-slate-500 transition-all"
                                        >
                                            üîÑ Analyser une Autre Photo
                                        </button>
                                    </div>
                                ) : uploadedImage && !isAnalyzing ? (
                                    <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-12 flex items-center justify-center">
                                        <button
                                            onClick={() => analyzeImage(uploadedImage)}
                                            className="bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold py-4 px-10 rounded-xl text-lg hover:shadow-lg hover:shadow-blue-500/50 transition-all"
                                        >
                                            üöÄ Lancer l'Analyse
                                        </button>
                                    </div>
                                ) : (
                                    <div className="bg-slate-800/50 border border-slate-700 rounded-2xl p-12 flex items-center justify-center min-h-96">
                                        <div className="text-center">
                                            <p className="text-slate-400 text-xl">üì∏ D√©pose une photo pour commencer</p>
                                            <p className="text-slate-500 text-sm mt-2">Analyse compl√®te : technique, composition, styles</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>

                    {/* Footer */}
                    <footer className="border-t border-slate-700 bg-slate-900/50 mt-16">
                        <div className="max-w-7xl mx-auto px-6 py-8 text-center text-slate-400 text-sm">
                            <p>üöÄ PhotoAI Analyzer - B√™ta Exclusive Club Photo</p>
                        </div>
                    </footer>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<PhotoAnalyzer />);
    </script>
</body>
</html>